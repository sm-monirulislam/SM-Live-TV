name: ğŸ“º Auto Combine Live TV M3U

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # à¦ªà§à¦°à¦¤à¦¿ à§§ à¦˜à¦£à§à¦Ÿà¦¾à§Ÿ à¦°à¦¾à¦¨

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - name: ğŸ” Check if any workflow is running
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
      run: |
        echo "ğŸ”„ Checking for active workflows..."

        RUNNING=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
          "https://api.github.com/repos/$REPO/actions/runs?status=in_progress&per_page=1" | jq '.total_count')

        if [ "$RUNNING" -gt 0 ]; then
          echo "âš ï¸ Another workflow is running. Waiting 2 minutes..."
          sleep 120
        else
          echo "ğŸŸ¢ No workflow running. Starting immediately..."
        fi

    - name: ğŸ”¹ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: ğŸ§  Run Combine Playlist Script
      run: |
        python Script/combine_playlist.py

    - name: ğŸ”„ Pull latest changes
      run: |
        git fetch origin
        git reset --soft origin/main

    - name: ğŸ•’ Commit & Push Updates
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "actions@github.com"

        git add Combined_Live_TV.m3u
        git commit -m "â™»ï¸ Auto updated Combined_Live_TV.m3u at $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes"

        git push origin main
